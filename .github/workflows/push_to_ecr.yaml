name: Deploy to AWS Lambda
run-name: ${{ github.actor }} is running backend CD
on:
  push:
    branches: ["main"]
  workflow_dispatch:
permissions:
  id-token: write
  contents: write
jobs:
  build-push-ecr:
    name: Deploy
    runs-on: ubuntu-latest
    steps:
      - name: Install Terraform CLI
        run: |
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.9.5"
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-region: ${{ secrets.AWS_REGION }}
          role-to-assume: ${{ secrets.ROLE_TO_ASSUME }}
          role-session-name: GitHub_to_AWS_via_FederatedOIDC
      - name: Check out repository
        uses: actions/checkout@v4
      - name: Login to ECR
        run: |
          aws ecr get-login-password --region ${{ secrets.AWS_REGION }} | \
          docker login --username AWS --password-stdin ${{ secrets.ECR_REPO_URI }}
      - name: building the docker image and push it into ECR
        run: |
          cd bucket-viewer-backend
          docker build -t ${{ secrets.IMAGE_NAME }} .
          docker tag ${{ secrets.ECR_REPO_NAME }}:latest ${{ secrets.ECR_REPO_URI }}:latest
          docker push ${{ secrets.ECR_REPO_URI }}:latest
      - name: Deploy with Terraform
        run: |
          cd infrastructure
          terraform init
          terraform plan 
          terraform apply -auto-approve

      # Add any additional inputs this action supports
